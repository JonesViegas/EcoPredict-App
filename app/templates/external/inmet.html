{% extends "base.html" %}
{% block title %}INMET - EcoPredict{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-cloud-sun me-2"></i>
                INMET - Dados Meteorol√≥gicos
            </h1>
            <p class="text-muted">Busque dados meteorol√≥gicos das esta√ß√µes do Instituto Nacional de Meteorologia</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card card-custom">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search me-2"></i>
                        Par√¢metros de Busca
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="inmetForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label" for="stateSelect">Estado</label>
                                <select class="form-select" id="stateSelect">
                                    <option value="">Selecione um estado</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amap√°</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Cear√°</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Esp√≠rito Santo</option>
                                    <option value="GO">Goi√°s</option>
                                    <option value="MA">Maranh√£o</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Par√°</option>
                                    <option value="PB">Para√≠ba</option>
                                    <option value="PR">Paran√°</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piau√≠</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rond√¥nia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">S√£o Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label" for="stationSelect">Esta√ß√£o Meteorol√≥gica *</label>
                                <select class="form-select" name="station_code" id="stationSelect" required disabled>
                                    <option value="">Selecione um estado primeiro</option>
                                </select>
                                <small class="form-text text-muted" id="stationInfo">
                                    Selecione uma esta√ß√£o para ver informa√ß√µes detalhadas
                                </small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" for="date_from">Data Inicial *</label>
                                <input type="date" class="form-control" id="date_from" name="date_from" required
                                       value="{{ request.form.get('date_from', '') }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" for="date_to">Data Final *</label>
                                <input type="date" class="form-control" id="date_to" name="date_to" required
                                       value="{{ request.form.get('date_to', '') }}">
                            </div>

                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Dados dispon√≠veis:</strong> Temperatura, Umidade, Press√£o, Vento, Precipita√ß√£o e mais.
                                </div>
                            </div>

                            <div class="col-12">
                                <button type="submit" id="submitBtn" class="btn btn-success btn-lg w-100" disabled>
                                    <i class="fas fa-cloud-download-alt me-2"></i>
                                    Buscar Dados Meteorol√≥gicos
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Informa√ß√µes -->
            <div class="card card-custom">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Sobre o INMET
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>INMET</strong> - Instituto Nacional de Meteorologia fornece dados meteorol√≥gicos oficiais do Brasil.</p>
                    
                    <h6>üå§Ô∏è Dados Dispon√≠veis:</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-temperature-high text-success me-2"></i> Temperatura</li>
                        <li><i class="fas fa-tint text-success me-2"></i> Umidade</li>
                        <li><i class="fas fa-wind text-success me-2"></i> Velocidade do Vento</li>
                        <li><i class="fas fa-compress-alt text-success me-2"></i> Press√£o Atmosf√©rica</li>
                        <li><i class="fas fa-cloud-rain text-success me-2"></i> Precipita√ß√£o</li>
                        <li><i class="fas fa-sun text-success me-2"></i> Radia√ß√£o Solar</li>
                    </ul>

                    <h6>üì° Cobertura:</h6>
                    <p>Esta√ß√µes autom√°ticas em todo o territ√≥rio brasileiro.</p>

                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Algumas esta√ß√µes podem ter dados incompletos em certos per√≠odos.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stateSelect = document.getElementById('stateSelect');
    const stationSelect = document.getElementById('stationSelect');
    const stationInfo = document.getElementById('stationInfo');
    const submitBtn = document.getElementById('submitBtn');

    // Fun√ß√£o para carregar esta√ß√µes do INMET
    function loadINMETStations() {
        const state = stateSelect.value;
        
        // Reseta e desabilita os campos dependentes
        stationSelect.innerHTML = '<option value="">Carregando esta√ß√µes...</option>';
        stationSelect.disabled = true;
        submitBtn.disabled = true;
        stationInfo.textContent = 'Carregando informa√ß√µes das esta√ß√µes...';
        
        // Se nenhum estado for selecionado, reseta os campos
        if (!state) {
            stationSelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
            stationInfo.textContent = 'Selecione uma esta√ß√£o para ver informa√ß√µes detalhadas';
            return;
        }

        // Fazer requisi√ß√£o para a API
        fetch(`/external/api/inmet/stations?state=${state}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Dados recebidos:', data); // Para debug
                
                if (data.success && data.stations && data.stations.length > 0) {
                    stationSelect.innerHTML = '<option value="">Selecione uma esta√ß√£o</option>';
                    
                    data.stations.forEach(station => {
                        const option = document.createElement('option');
                        option.value = station.code;
                        option.textContent = `${station.name} (${station.code})`;
                        // Armazena todas as informa√ß√µes da esta√ß√£o
                        option.dataset.station = JSON.stringify(station);
                        stationSelect.appendChild(option);
                    });
                    
                    stationSelect.disabled = false;
                    stationInfo.textContent = `${data.stations.length} esta√ß√µes encontradas. Selecione uma para ver detalhes.`;
                } else {
                    stationSelect.innerHTML = '<option value="">Nenhuma esta√ß√£o encontrada para este estado</option>';
                    stationInfo.textContent = 'Nenhuma esta√ß√£o dispon√≠vel para o estado selecionado.';
                }
            })
            .catch(error => {
                console.error('Erro ao buscar esta√ß√µes do INMET:', error);
                stationSelect.innerHTML = '<option value="">Erro ao carregar esta√ß√µes</option>';
                stationInfo.textContent = 'Erro ao carregar esta√ß√µes. Tente novamente.';
                stationInfo.className = 'form-text text-danger';
            });
    }

    // Fun√ß√£o para atualizar informa√ß√µes da esta√ß√£o selecionada
    function updateStationInfo() {
        const selectedOption = stationSelect.options[stationSelect.selectedIndex];
        
        if (selectedOption.value && selectedOption.dataset.station) {
            try {
                const station = JSON.parse(selectedOption.dataset.station);
                stationInfo.innerHTML = `
                    <strong>${station.name}</strong><br>
                    <small>C√≥digo: ${station.code} | Estado: ${station.state}</small><br>
                    <small>Lat: ${station.latitude} | Lon: ${station.longitude}</small>
                `;
                stationInfo.className = 'form-text text-success';
            } catch (e) {
                console.error('Erro ao parsear dados da esta√ß√£o:', e);
                stationInfo.textContent = 'Informa√ß√µes da esta√ß√£o dispon√≠veis';
                stationInfo.className = 'form-text text-muted';
            }
        } else {
            stationInfo.textContent = 'Selecione uma esta√ß√£o para ver informa√ß√µes detalhadas';
            stationInfo.className = 'form-text text-muted';
        }
    }

    // Fun√ß√£o para atualizar o estado do bot√£o de busca
    function updateSubmitButtonState() {
        const isFormValid = stateSelect.value && 
                           stationSelect.value && 
                           document.getElementById('date_from').value && 
                           document.getElementById('date_to').value;
        
        submitBtn.disabled = !isFormValid;
    }

    // Event listeners
    stateSelect.addEventListener('change', function() {
        loadINMETStations();
        updateSubmitButtonState();
    });

    stationSelect.addEventListener('change', function() {
        updateStationInfo();
        updateSubmitButtonState();
    });

    // Validar datas tamb√©m
    document.getElementById('date_from').addEventListener('change', updateSubmitButtonState);
    document.getElementById('date_to').addEventListener('change', updateSubmitButtonState);

    // Configurar datas padr√£o (√∫ltimos 7 dias)
    const today = new Date().toISOString().split('T')[0];
    const dateFrom = document.getElementById('date_from');
    const dateTo = document.getElementById('date_to');
    
    if (!dateTo.value) {
        dateTo.value = today;
    }
    if (!dateFrom.value) {
        const lastWeek = new Date();
        lastWeek.setDate(lastWeek.getDate() - 7);
        dateFrom.value = lastWeek.toISOString().split('T')[0];
    }

    // Atualizar estado inicial do bot√£o
    updateSubmitButtonState();
});
</script>
{% endblock %}