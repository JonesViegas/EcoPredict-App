{% extends "base.html" %}

{% block title %}OpenAQ - EcoPredict{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- T√≠tulo principal -->
    <div class="text-center mb-5">
        <h1 class="fw-bold text-primary">
            <i class="fas fa-wind"></i> Dados de Qualidade do Ar (OpenAQ)
        </h1>
        <p class="text-muted">Busque dados de m√∫ltiplos poluentes para uma an√°lise completa.</p>
    </div>

    <div class="row justify-content-center">
        <!-- CARD: OpenAQ -->
        <div class="col-lg-8 col-md-10">
            <div class="card card-custom">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search me-2"></i>
                        Par√¢metros de Busca
                    </h5>
                </div>
                
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        O sistema buscar√° todos os principais poluentes (PM2.5, PM10, O‚ÇÉ, CO, NO‚ÇÇ, SO‚ÇÇ) para a localiza√ß√£o e per√≠odo selecionados e os consolidar√° em um √∫nico dataset.
                    </p>
                    
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <form method="POST" id="openaqForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="mb-3">
                            <label for="location" class="form-label fw-semibold">Localiza√ß√£o *</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   placeholder="Ex: S√£o Paulo, London, New York" required 
                                   value="{{ request.form.get('location', '') }}">
                            <small class="form-text text-muted">
                                Nome da cidade, estado ou pa√≠s. Use ingl√™s para melhores resultados.
                            </small>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Data Inicial</label>
                                <input type="date" class="form-control" id="date_from" name="date_from" 
                                       value="{{ request.form.get('date_from', '') }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Data Final</label>
                                <input type="date" class="form-control" id="date_to" name="date_to" 
                                       value="{{ request.form.get('date_to', '') }}">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="limit" class="form-label fw-semibold">Limite de Registros por Poluente</label>
                            <select class="form-select" id="limit" name="limit">
                                <option value="100">100 registros</option>
                                <option value="500" selected>500 registros</option>
                                <option value="1000">1.000 registros</option>
                                <option value="5000">5.000 registros</option>
                            </select>
                        </div>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100 fw-semibold py-2">
                                <i class="fas fa-download me-2"></i>Buscar e Analisar Dados
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Card de informa√ß√µes -->
            <div class="card card-custom mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informa√ß√µes Importantes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üåç Exemplos de Busca:</h6>
                            <ul class="list-unstyled small">
                                <li><i class="fas fa-check text-success me-2"></i> <strong>S√£o Paulo</strong> - Brasil</li>
                                <li><i class="fas fa-check text-success me-2"></i> <strong>London</strong> - Reino Unido</li>
                                <li><i class="fas fa-check text-success me-2"></i> <strong>California</strong> - EUA</li>
                                <li><i class="fas fa-check text-success me-2"></i> <strong>Berlin</strong> - Alemanha</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>üìä Poluentes Inclu√≠dos:</h6>
                            <ul class="list-unstyled small">
                                <li><i class="fas fa-smog text-info me-2"></i> PM2.5 e PM10</li>
                                <li><i class="fas fa-wind text-info me-2"></i> Oz√¥nio (O‚ÇÉ)</li>
                                <li><i class="fas fa-industry text-info me-2"></i> Mon√≥xido de Carbono (CO)</li>
                                <li><i class="fas fa-cloud text-info me-2"></i> Di√≥xido de Enxofre (SO‚ÇÇ)</li>
                                <li><i class="fas fa-car text-info me-2"></i> Di√≥xido de Nitrog√™nio (NO‚ÇÇ)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SE√á√ÉO DE RESULTADOS (aparece ap√≥s a busca) -->
    {% if dataset %}
    <div class="row justify-content-center mt-5">
        <div class="col-lg-10">
            <div class="card card-custom">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Resultados da Coleta</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <strong>Sucesso!</strong> Foram coletados e processados <strong>{{ dataset.rows_count }}</strong> registros.
                        <br> O dataset completo foi salvo como 
                        <a href="{{ url_for('main.datasets') }}" class="alert-link">"{{ dataset.original_filename }}"</a>.
                    </div>
                    
                    <!-- Informa√ß√µes do Dataset -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>üìã Informa√ß√µes do Dataset</h6>
                                    <p class="mb-1"><strong>Localiza√ß√£o:</strong> {{ request.form.get('location', 'N/A') }}</p>
                                    <p class="mb-1"><strong>Per√≠odo:</strong> {{ request.form.get('date_from', 'N/A') }} a {{ request.form.get('date_to', 'N/A') }}</p>
                                    <p class="mb-1"><strong>Registros:</strong> {{ dataset.rows_count }}</p>
                                    <p class="mb-0"><strong>Colunas:</strong> {{ dataset.columns_count }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>üìà Qualidade dos Dados</h6>
                                    <p class="mb-1"><strong>Score de Qualidade:</strong> {{ "%.1f"|format(dataset.data_quality_score) }}%</p>
                                    <p class="mb-1"><strong>Dados Faltantes:</strong> {{ "%.1f"|format(dataset.missing_data_percentage) }}%</p>
                                    <p class="mb-0"><strong>Status:</strong> 
                                        <span class="badge bg-success">Processado</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- A√ß√µes -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('main.datasets') }}" class="btn btn-outline-primary">
                            <i class="fas fa-list me-2"></i>Ver Todos os Datasets
                        </a>
                        <a href="{{ url_for('main.ml_models') }}" class="btn btn-success">
                            <i class="fas fa-brain me-2"></i>Treinar Modelo com Estes Dados
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Loading -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                <h6>Coletando e processando dados...</h6>
                <p class="small text-muted mb-0">Isso pode levar alguns instantes.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configura as datas padr√£o (√∫ltimos 7 dias)
    const today = new Date();
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(today.getDate() - 7);
    
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    // Preenche as datas apenas se estiverem vazias
    const dateFrom = document.getElementById('date_from');
    const dateTo = document.getElementById('date_to');
    
    if (dateFrom && !dateFrom.value) {
        dateFrom.value = formatDate(sevenDaysAgo);
    }
    if (dateTo && !dateTo.value) {
        dateTo.value = formatDate(today);
    }

    // Mostra o modal de loading ao enviar o formul√°rio
    const form = document.getElementById('openaqForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const btn = this.querySelector('button[type="submit"]');
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Processando...`;
                const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
                loadingModal.show();
            }
        });
    }
});
</script>
{% endblock %}