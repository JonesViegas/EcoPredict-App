{% extends "base.html" %}
{% block title %}Modelos de Machine Learning - EcoPredict{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-brain me-2"></i>
                Modelos de Machine Learning
            </h1>
            <p class="text-muted">Treine e gerencie modelos preditivos para qualidade do ar</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Training Form -->
        <div class="col-lg-6">
            <div class="card card-custom">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plus me-2"></i>
                        Treinar Novo Modelo
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.ml_models') }}" id="mlForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row g-3">
                            <div class="col-12">
                                {{ form.name.label(class="form-label") }}
                                {{ form.name(class="form-control", placeholder="Nome do modelo (ex: Previs√£o AQI S√£o Paulo)") }}
                                {% if form.name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                {{ form.model_type.label(class="form-label") }}
                                {{ form.model_type(class="form-select") }}
                                <small class="form-text text-muted">
                                    Regress√£o: valores num√©ricos<br>
                                    Classifica√ß√£o: categorias
                                </small>
                            </div>
                            
                            <div class="col-md-6">
                                {{ form.algorithm.label(class="form-label") }}
                                {{ form.algorithm(class="form-select") }}
                                <small class="form-text text-muted">
                                    Random Forest: Melhor para in√≠cio<br>
                                    XGBoost: Alta performance
                                </small>
                            </div>
                            
                            <!-- Dataset Selection -->
                            <div class="col-12">
                                <label class="form-label">Dataset *</label>
                                <select name="dataset_id" class="form-select" id="datasetSelect" required>
                                    <option value="">Selecione um dataset</option>
                                    {% for dataset in datasets %}
                                    <option value="{{ dataset.id }}" 
                                            data-features='[]'
                                            data-rows="{{ dataset.rows_count }}">
                                        {{ dataset.original_filename }} ({{ dataset.rows_count }} linhas)
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Selecione um dataset com dados de qualidade do ar
                                </small>
                            </div>
                            
                            <!-- Features Selection -->
                            <div class="col-12">
                                <label class="form-label">Vari√°veis de Entrada (Features) *</label>
                                <div id="features-container" class="border rounded p-3 bg-light" style="min-height: 120px;">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-database me-2"></i>
                                        Selecione um dataset para carregar as vari√°veis dispon√≠veis
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    Selecione as vari√°veis que ser√£o usadas para fazer previs√µes
                                </small>
                            </div>
                            
                            <!-- Target Variable -->
                            <div class="col-12">
                                {{ form.target_variable.label(class="form-label") }}
                                {{ form.target_variable(class="form-control", placeholder="Ex: Overall_AQI, pm25, AQI_Category", id="targetVariable") }}
                                <small class="form-text text-muted">
                                    Vari√°vel que voc√™ quer prever. Exemplos comuns: Overall_AQI, pm25, temperature
                                </small>
                                {% if form.target_variable.errors %}
                                    <div class="text-danger">
                                        {% for error in form.target_variable.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Test Size -->
                            <div class="col-12">
                                {{ form.test_size.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.test_size(class="form-control", type="number", step="0.01", min="0.1", max="0.5", value="0.2") }}
                                    <span class="input-group-text">% para teste</span>
                                </div>
                                <small class="form-text text-muted">
                                    20% √© recomendado. Dados maiores podem usar menos.
                                </small>
                            </div>
                            
                            <!-- Model Info -->
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Dica:</strong> Para prever qualidade do ar, use features como PM2.5, temperatura, umidade e vento.
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <button type="submit" class="btn btn-success btn-lg w-100" id="trainButton">
                                    <i class="fas fa-play me-2"></i>
                                    Treinar Modelo
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Models List -->
        <div class="col-lg-6">
            <div class="card card-custom">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        Meus Modelos
                    </h5>
                </div>
                <div class="card-body">
                    {% if models %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Algoritmo</th>
                                    <th>Precis√£o</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in models %}
                                <tr>
                                    <td>
                                        <div class="fw-semibold">{{ model.name }}</div>
                                        <small class="text-muted">Alvo: {{ model.target_variable }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ model.algorithm|replace('_', ' ')|title }}</span>
                                    </td>
                                    <td>
                                        <span class="badge {% if model.accuracy >= 0.85 %}bg-success{% elif model.accuracy >= 0.70 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(model.accuracy * 100) }}%
                                        </span>
                                    </td>
                                    <td>
                                        {% if model.is_active %}
                                            <span class="badge bg-success">Ativo</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inativo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if model.accuracy >= 0.70 %}
                                                <a href="{{ url_for('main.toggle_model', model_id=model.id) }}" 
                                                   class="btn btn-outline-{% if model.is_active %}warning{% else %}success{% endif %}"
                                                   title="{% if model.is_active %}Desativar{% else %}Ativar{% endif %} Modelo">
                                                    <i class="fas fa-{% if model.is_active %}pause{% else %}play{% endif %}"></i>
                                                </a>
                                            {% endif %}
                                            <button class="btn btn-outline-info" 
                                                    onclick="showModelDetails({{ model.id }})"
                                                    title="Ver Detalhes">
                                                <i class="fas fa-info"></i>
                                            </button>
                                            <button class="btn btn-outline-primary"
                                                    onclick="makePrediction({{ model.id }})"
                                                    title="Fazer Previs√£o">
                                                <i class="fas fa-bolt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-brain fa-3x mb-3"></i>
                        <p>Nenhum modelo treinado ainda.</p>
                        <p class="small">Use o formul√°rio ao lado para treinar seu primeiro modelo.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Performance Guidelines -->
            <div class="card card-custom mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Diretrizes de Performance
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">Precis√£o ‚â• 85%</span>
                                <span class="badge bg-success">Excelente</span>
                            </div>
                            <small class="text-muted d-block">Modelo considerado confi√°vel e ativado automaticamente</small>
                        </div>
                        <div class="col-12 mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">Precis√£o 70-84%</span>
                                <span class="badge bg-warning">Bom</span>
                            </div>
                            <small class="text-muted d-block">Modelo √∫til mas precisa de melhorias</small>
                        </div>
                        <div class="col-12 mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">Precis√£o < 70%</span>
                                <span class="badge bg-danger">Insuficiente</span>
                            </div>
                            <small class="text-muted d-block">Recomenda-se retreinamento com mais dados</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="card card-custom mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Dicas R√°pidas
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Para AQI:</strong> Use PM2.5, PM10, temperatura, umidade
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Para PM2.5:</strong> Use vento, press√£o, outras polui√ß√µes
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Dados:</strong> M√≠nimo 100 registros para bons resultados
                        </li>
                        <li>
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Features:</strong> 3-8 vari√°veis √© o ideal
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Details Modal -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Modelo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modelDetailsContent">
                <!-- Content will be loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Prediction Modal -->
<div class="modal fade" id="predictionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fazer Previs√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="predictionContent">
                <!-- Content will be loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                <h6>Treinando modelo...</h6>
                <p class="small text-muted mb-0">Isso pode levar alguns minutos.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentFeatures = [];

// Load features when dataset is selected
document.getElementById('datasetSelect').addEventListener('change', function() {
    const datasetId = this.value;
    const featuresContainer = document.getElementById('features-container');
    const targetInput = document.getElementById('targetVariable');
    const selectedOption = this.options[this.selectedIndex];
    
    if (!datasetId) {
        featuresContainer.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-database me-2"></i>
                Selecione um dataset para carregar as vari√°veis dispon√≠veis
            </div>
        `;
        targetInput.placeholder = "Ex: Overall_AQI, pm25, AQI_Category";
        return;
    }
    
    featuresContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <span class="ms-2">Carregando vari√°veis do dataset...</span>
        </div>
    `;
    
    // Fetch features from the server
    fetch(`/api/dataset-features/${datasetId}`)
        .then(response => {
            if (!response.ok) throw new Error('Erro na resposta do servidor');
            return response.json();
        })
        .then(data => {
            if (data.success && data.features && data.features.length > 0) {
                currentFeatures = data.features;
                renderFeaturesSelection(data.features);
                
                // Suggest common target variables
                suggestTargetVariables(data.features);
                
            } else {
                featuresContainer.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        N√£o foi poss√≠vel carregar as vari√°veis deste dataset.
                        ${data.error ? `Erro: ${data.error}` : ''}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading features:', error);
            featuresContainer.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-times-circle me-2"></i>
                    Erro ao carregar vari√°veis. Verifique se o dataset √© v√°lido.
                </div>
            `;
        });
});

function renderFeaturesSelection(features) {
    const featuresContainer = document.getElementById('features-container');
    const recommendedFeatures = ['pm25', 'pm10', 'temperature', 'humidity', 'wind_speed', 'pressure', 'o3', 'no2', 'so2', 'co'];
    const targetFeatures = ['Overall_AQI', 'AQI_Category', 'pm25', 'pm10', 'temperature'];
    
    let featuresHtml = `
        <div class="mb-2">
            <small class="text-muted">
                <i class="fas fa-mouse-pointer me-1"></i>
                Selecione as vari√°veis de entrada (m√≠nimo 1):
            </small>
        </div>
        <div class="row g-2" style="max-height: 200px; overflow-y: auto;">
    `;
    
    features.forEach(feature => {
        const isRecommended = recommendedFeatures.includes(feature);
        const isTarget = targetFeatures.includes(feature);
        
        featuresHtml += `
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input feature-checkbox" type="checkbox" 
                           name="features" value="${feature}" id="feature_${feature}"
                           ${isRecommended ? 'checked' : ''}>
                    <label class="form-check-label d-flex align-items-center" for="feature_${feature}">
                        <span class="feature-name">${feature}</span>
                        ${isRecommended ? '<span class="badge bg-success ms-2" title="Recomendada">‚òÖ</span>' : ''}
                        ${isTarget ? '<span class="badge bg-info ms-2" title="Boa para previs√£o">üéØ</span>' : ''}
                    </label>
                </div>
            </div>
        `;
    });
    
    featuresHtml += `
        </div>
        <div class="mt-2">
            <small class="text-muted" id="selectedCount">0 vari√°veis selecionadas</small>
        </div>
    `;
    
    featuresContainer.innerHTML = featuresHtml;
    
    // Add event listeners to checkboxes
    document.querySelectorAll('.feature-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.feature-checkbox:checked').length;
    const countElement = document.getElementById('selectedCount');
    if (countElement) {
        countElement.textContent = `${selectedCount} vari√°vel(s) selecionada(s)`;
        countElement.className = `text-${selectedCount > 0 ? 'success' : 'muted'}`;
    }
}

function suggestTargetVariables(features) {
    const targetInput = document.getElementById('targetVariable');
    const commonTargets = ['Overall_AQI', 'AQI_Category', 'pm25', 'pm10', 'temperature', 'humidity'];
    
    // Find the first common target that exists in features
    const suggestedTarget = commonTargets.find(target => features.includes(target));
    
    if (suggestedTarget) {
        targetInput.placeholder = `Ex: ${suggestedTarget}`;
        if (!targetInput.value) {
            targetInput.value = suggestedTarget;
        }
    } else if (features.length > 0) {
        targetInput.placeholder = `Ex: ${features[0]}`;
    }
}

// Form validation and loading
document.getElementById('mlForm').addEventListener('submit', function(e) {
    const selectedFeatures = document.querySelectorAll('.feature-checkbox:checked');
    const targetVariable = document.getElementById('targetVariable').value;
    const datasetId = document.getElementById('datasetSelect').value;
    
    // Basic validation
    if (!datasetId) {
        e.preventDefault();
        alert('Por favor, selecione um dataset.');
        return;
    }
    
    if (selectedFeatures.length === 0) {
        e.preventDefault();
        alert('Por favor, selecione pelo menos uma vari√°vel de entrada.');
        return;
    }
    
    if (!targetVariable) {
        e.preventDefault();
        alert('Por favor, informe a vari√°vel alvo.');
        return;
    }
    
    // Check if target is in features
    const featureValues = Array.from(selectedFeatures).map(cb => cb.value);
    if (featureValues.includes(targetVariable)) {
        if (!confirm('A vari√°vel alvo tamb√©m est√° selecionada como entrada. Isso pode causar overfitting. Continuar?')) {
            e.preventDefault();
            return;
        }
    }
    
    // Show loading modal
    const trainButton = document.getElementById('trainButton');
    trainButton.disabled = true;
    trainButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Treinando...';
    
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
});

// Model details function
function showModelDetails(modelId) {
    const modalContent = document.getElementById('modelDetailsContent');
    modalContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Carregando detalhes do modelo...</p>
        </div>
    `;
    
    // Simulate API call - in real implementation, fetch from server
    setTimeout(() => {
        modalContent.innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <strong>ID do Modelo:</strong> ${modelId}
                </div>
                <div class="col-md-6">
                    <strong>Status:</strong> <span class="badge bg-success">Ativo</span>
                </div>
                <div class="col-md-6">
                    <strong>Algoritmo:</strong> Random Forest
                </div>
                <div class="col-md-6">
                    <strong>Tipo:</strong> Regress√£o
                </div>
                <div class="col-md-6">
                    <strong>Precis√£o:</strong> 87.5%
                </div>
                <div class="col-md-6">
                    <strong>Vari√°vel Alvo:</strong> Overall_AQI
                </div>
                <div class="col-12">
                    <strong>Vari√°veis de Entrada:</strong><br>
                    <span class="badge bg-light text-dark me-1">pm25</span>
                    <span class="badge bg-light text-dark me-1">temperature</span>
                    <span class="badge bg-light text-dark me-1">humidity</span>
                    <span class="badge bg-light text-dark me-1">wind_speed</span>
                </div>
                <div class="col-12">
                    <strong>Data de Treinamento:</strong> ${new Date().toLocaleDateString('pt-BR')}
                </div>
                <div class="col-12">
                    <strong>Performance:</strong>
                    <div class="progress mt-1" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: 87.5%"></div>
                    </div>
                    <small class="text-muted">87.5% de precis√£o</small>
                </div>
            </div>
        `;
    }, 1000);
    
    const modal = new bootstrap.Modal(document.getElementById('modelDetailsModal'));
    modal.show();
}

// Prediction function
function makePrediction(modelId) {
    const modalContent = document.getElementById('predictionContent');
    modalContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Preparando interface de previs√£o...</p>
        </div>
    `;
    
    // Simulate prediction interface
    setTimeout(() => {
        modalContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Insira os valores para fazer uma previs√£o
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">PM2.5 (Œºg/m¬≥)</label>
                    <input type="number" class="form-control" value="25" step="0.1">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Temperatura (¬∞C)</label>
                    <input type="number" class="form-control" value="28" step="0.1">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Umidade (%)</label>
                    <input type="number" class="form-control" value="65" step="0.1">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Velocidade do Vento (m/s)</label>
                    <input type="number" class="form-control" value="5" step="0.1">
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <button class="btn btn-primary" onclick="showPredictionResult()">
                    <i class="fas fa-bolt me-2"></i>
                    Fazer Previs√£o
                </button>
            </div>
        `;
    }, 1000);
    
    const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
    modal.show();
}

function showPredictionResult() {
    const modalContent = document.getElementById('predictionContent');
    modalContent.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Previs√£o Conclu√≠da</h6>
            <p class="mb-0">AQI Previsto: <strong>78.3</strong> (Moderado)</p>
        </div>
        
        <div class="row text-center mt-3">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body py-3">
                        <h6>Confian√ßa</h6>
                        <h4 class="text-success">87%</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body py-3">
                        <h6>Categoria</h6>
                        <h4 class="text-warning">Moderado</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body py-3">
                        <h6>Recomenda√ß√£o</h6>
                        <small>Atividade normal</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3 text-center">
            <button class="btn btn-outline-secondary" onclick="makePrediction(1)">
                <i class="fas fa-redo me-2"></i>
                Nova Previs√£o
            </button>
        </div>
    `;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('ML Models page loaded');
});
</script>

<style>
.feature-checkbox:checked + label .feature-name {
    font-weight: 600;
    color: #198754;
}

.card-custom {
    transition: transform 0.2s;
}

.card-custom:hover {
    transform: translateY(-2px);
}

#features-container {
    transition: all 0.3s ease;
}

.progress {
    background-color: #e9ecef;
}
</style>
{% endblock %}