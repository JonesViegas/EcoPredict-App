{% extends "base.html" %}
{% block title %}Configurações do Sistema - EcoPredict{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-cogs me-2"></i>
                Configurações do Sistema
            </h1>
            <p class="text-muted">Gerencie as configurações globais e a manutenção do EcoPredict</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.admin_panel') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Voltar ao Painel
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Coluna Esquerda: Informações e Configurações -->
        <div class="col-lg-7">
            <!-- Informações do Sistema -->
            <div class="card card-custom mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Informações do Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 200px;">Versão Python:</td>
                                    <td><span class="badge bg-primary">{{ system_info.python_version }}</span></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Versão Flask:</td>
                                    <td><span class="badge bg-secondary">{{ system_info.flask_version }}</span></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Sistema Operacional:</td>
                                    <td>{{ system_info.system }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Tempo de Atividade:</td>
                                    <td id="uptime">Calculando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Configurações Gerais e API -->
            <div class="card card-custom">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-sliders-h me-2"></i>Configurações Gerais e API</h5>
                </div>
                <div class="card-body">
                    <form id="systemSettingsForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nome do Sistema</label>
                                <input type="text" class="form-control" value="EcoPredict" name="system_name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email do Administrador</label>
                                <input type="email" class="form-control" value="admin@ecopredict.com" name="admin_email">
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-6 mb-3">
                                <label class="form-label">Token WAQI (AQICN)</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" value="8f482fcd390f25d9c8f7bd230f20d485b1dfeb9a" name="aqicn_token">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleTokenVisibility(this)"><i class="fas fa-eye"></i></button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Permitir Registro de Usuários</label>
                                <div class="form-check form-switch pt-2">
                                    <input class="form-check-input" type="checkbox" id="userRegistration" name="user_registration" checked>
                                    <label class="form-check-label" for="userRegistration">Ativado</label>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-primary" onclick="saveSettings()">
                                <i class="fas fa-save me-2"></i>Salvar Configurações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Coluna Direita: Ações e Monitoramento -->
        <div class="col-lg-5">
            <!-- Ações do Sistema -->
            <div class="card card-custom mb-4">
                <div class="card card-custom mb-4">
                    {% include 'admin/_admin_actions.html' %}
                </div>

            </div>

            <!-- Monitoramento -->
            <div class="card card-custom">
                <div class="card-header">
                     <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Monitoramento em Tempo Real</h5>
                </div>
                <div class="card-body">
                    <div id="systemMetrics">
                        <div class="mb-3 cpu-monitor">
                            <div class="d-flex justify-content-between align-items-center"><small class="fw-bold">CPU</small><small class="fw-bold">0%</small></div>
                            <div class="progress" style="height: 6px;"><div class="progress-bar" role="progressbar" style="width: 0%;"></div></div>
                        </div>
                        <div class="mb-3 memory-monitor">
                            <div class="d-flex justify-content-between align-items-center"><small class="fw-bold">Memória</small><small class="fw-bold">0%</small></div>
                            <div class="progress" style="height: 6px;"><div class="progress-bar" role="progressbar" style="width: 0%;"></div></div>
                        </div>
                        <div class="disk-monitor">
                            <div class="d-flex justify-content-between align-items-center"><small class="fw-bold">Disco</small><small class="fw-bold">0%</small></div>
                            <div class="progress" style="height: 6px;"><div class="progress-bar" role="progressbar" style="width: 0%;"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin_actions.js') }}"></script>
<script>
    // --- FUNÇÃO GENÉRICA PARA AÇÕES DE ADMIN ---
    async function performAdminAction(url, options = {}, confirmMessage, successMessage) {
        if (confirmMessage && !confirm(confirmMessage)) {
            return;
        }

        showToast('Processando sua solicitação...', 'info');

        try {
            const response = await fetch(url, {
                method: options.method || 'POST',
                headers: { 'Content-Type': 'application/json', ...options.headers },
                body: options.body ? JSON.stringify(options.body) : null
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast(result.message || successMessage, 'success');
                return result; // Retorna o resultado para uso posterior se necessário
            } else {
                throw new Error(result.error || 'Ocorreu um erro no servidor.');
            }
        } catch (error) {
            console.error(`Erro ao executar a ação em ${url}:`, error);
            showToast(`Erro: ${error.message}`, 'danger');
        }
    }

    // --- FUNÇÕES DE MANUTENÇÃO ---
    function backupSystem() {
        performAdminAction('/admin/api/backup', {}, 'Deseja criar um backup completo do sistema agora?', 'Backup iniciado com sucesso!');
    }
    function clearSystemCache() {
        performAdminAction('/admin/api/clear_cache', {}, 'Limpar o cache do sistema? Isso pode desconectar usuários ativos.', 'Cache limpo com sucesso!');
    }
    function optimizeDatabase() {
        performAdminAction('/admin/api/optimize_db', {}, 'Otimizar o banco de dados? A operação pode levar alguns minutos.', 'Otimização do banco de dados concluída!');
    }
    function restartSystem() {
        performAdminAction('/admin/api/restart_system', {}, 'TEM CERTEZA que deseja reiniciar o sistema? A aplicação ficará indisponível por alguns instantes.', 'Comando de reinicialização enviado.');
    }
    function clearLogs() {
        performAdminAction('/admin/api/clear_old_logs', {}, 'Limpar todos os logs com mais de 30 dias? Esta ação não pode ser desfeita.', 'Logs antigos foram limpos com sucesso!');
    }

    // --- SALVAR CONFIGURAÇÕES (SIMULAÇÃO) ---
    function saveSettings() {
        // OBS: Esta função é uma simulação. Você precisa criar uma rota no backend
        // para receber e salvar estas configurações.
        const form = document.getElementById('systemSettingsForm');
        const formData = new FormData(form);
        const settings = Object.fromEntries(formData.entries());
        
        console.log("Configurações para salvar:", settings);
        showToast('Configurações salvas com sucesso (simulação)!', 'success');
        
        // Exemplo de como seria a chamada real:
        // performAdminAction('/admin/api/save_settings', { body: settings }, null, 'Configurações salvas!');
    }

    // --- MONITOREAMENTO E UI ---
    async function updateSystemMetrics() {
        try {
            const response = await fetch('/admin/api/system_stats');
            const result = await response.json();
            
            if (result.success) {
                const stats = result.stats;
                updateMetric('.cpu-monitor', stats.cpu_percent);
                updateMetric('.memory-monitor', stats.memory_percent);
                updateMetric('.disk-monitor', stats.disk_usage);
            }
        } catch (error) {
            console.error('Erro ao atualizar métricas:', error);
        }
    }

    function updateMetric(selector, value) {
        const element = document.querySelector(selector);
        const valueEl = element.querySelector('.fw-bold:last-child');
        const progressBar = element.querySelector('.progress-bar');
        
        valueEl.textContent = value + '%';
        progressBar.style.width = value + '%';
        
        progressBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        if (value > 80) progressBar.classList.add('bg-danger');
        else if (value > 60) progressBar.classList.add('bg-warning');
        else progressBar.classList.add('bg-success');
    }

    function updateUptime() {
        const startTime = new Date('{{ system_info.start_time.isoformat() if system_info.start_time else "" }}');
        if (!startTime || isNaN(startTime)) {
            document.getElementById('uptime').textContent = 'Indisponível';
            return;
        }
        const now = new Date();
        const diff = now - startTime;
        
        const days = Math.floor(diff / 86400000);
        const hours = Math.floor((diff % 86400000) / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        
        document.getElementById('uptime').textContent = `${days}d ${hours}h ${minutes}m`;
    }
    
    function toggleTokenVisibility(button) {
        const input = button.parentElement.querySelector('input');
        const icon = button.querySelector('i');
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        icon.className = isPassword ? 'fas fa-eye-slash' : 'fas fa-eye';
    }

    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', function() {
        updateUptime();
        setInterval(updateUptime, 60000); // Atualiza a cada minuto

        updateSystemMetrics();
        setInterval(updateSystemMetrics, 5000); // Atualiza a cada 5 segundos

        const maintenanceCheckbox = document.getElementById('maintenanceMode');
        maintenanceCheckbox.addEventListener('change', () => {
            const isChecked = maintenanceCheckbox.checked;
            const message = isChecked ? 'Ativar o modo manutenção?' : 'Desativar o modo manutenção?';
            if (confirm(message)) {
                performAdminAction('/admin/api/toggle_maintenance', { body: { maintenance_mode: isChecked } }, null, 'Modo manutenção atualizado!');
            } else {
                maintenanceCheckbox.checked = !isChecked;
            }
        });
    });

    // Função de Toast (placeholder)
    function showToast(message, type = 'info') {
        // Você pode substituir por uma biblioteca de toast como Toastify ou Bootstrap Toasts
        alert(`[${type.toUpperCase()}] ${message}`);
    }
</script>
{% endblock %}