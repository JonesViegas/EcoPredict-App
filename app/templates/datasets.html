{% extends "base.html" %}
{% block title %}Meus Datasets - EcoPredict{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-database me-2"></i>
                Meus Datasets
            </h1>
            <p class="text-muted">Gerencie e analise seus datasets de qualidade do ar</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.upload_data') }}" class="btn btn-success">
                <i class="fas fa-plus me-2"></i>
                Novo Dataset
            </a>
        </div>
    </div>

    <!-- User Datasets -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card card-custom">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>
                        Meus Datasets
                    </h5>
                </div>
                <div class="card-body">
                    {% if user_datasets %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="datasetsTable">
                            <thead>
                                <tr>
                                    <th>Nome do Arquivo</th>
                                    <th>Tamanho</th>
                                    <th>Linhas</th>
                                    <th>Colunas</th>
                                    <th>Qualidade</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dataset in user_datasets %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-csv text-primary me-2"></i>
                                        <div>
                                            <strong>{{ dataset.original_filename }}</strong>
                                            {% if dataset.description %}
                                                <br><small class="text-muted">{{ dataset.description[:50] }}{% if dataset.description|length > 50 %}...{% endif %}</small>
                                            {% endif %}
                                            <br>
                                            <span class="badge bg-light text-dark mt-1">Fonte: {{ dataset.source or 'N/A' }}</span>
                                            {% if dataset.is_public %}
                                                <span class="badge bg-success mt-1">Público</span>
                                            {% else %}
                                                <span class="badge bg-secondary mt-1">Privado</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>{{ "%.1f"|format(dataset.file_size / 1024 / 1024) }} MB</td>
                                    <td>{{ dataset.rows_count }}</td>
                                    <td>{{ dataset.columns_count }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                                <div class="progress-bar 
                                                    {% if dataset.data_quality_score >= 80 %}bg-success
                                                    {% elif dataset.data_quality_score >= 60 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    style="width: {{ dataset.data_quality_score }}%">
                                                </div>
                                            </div>
                                            <small>{{ "%.0f"|format(dataset.data_quality_score) }}%</small>
                                        </div>
                                    </td>
                                    <td>{{ dataset.uploaded_at.strftime('%d/%m/%Y') if dataset.uploaded_at else 'N/A' }}</td>
                                    
                                    <!-- =============================================== -->
                                    <!--          INÍCIO DA SEÇÃO CORRIGIDA              -->
                                    <!-- =============================================== -->
                                    <td>
                                        <div class="d-flex gap-2">
                                            <!-- Botão Principal de Análise -->
                                            <a href="{{ url_for('main.analysis_lab', dataset_id=dataset.id) }}" 
                                               class="btn btn-warning btn-sm" 
                                               title="Analisar no Laboratório">
                                                <i class="fas fa-flask me-1"></i> Analisar
                                            </a>
                                            <!-- Menu Dropdown para Outras Ações -->
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Mais Opções">
                                                    <i class="fas fa-ellipsis-h"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li><a class="dropdown-item" href="#" onclick="viewDataset({{ dataset.id }})"><i class="fas fa-eye fa-fw me-2"></i>Visualizar Prévia</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="showDatasetInfo({{ dataset.id }})"><i class="fas fa-info-circle fa-fw me-2"></i>Informações Detalhadas</a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item" href="{{ url_for('main.download_dataset', dataset_id=dataset.id) }}"><i class="fas fa-download fa-fw me-2"></i>Baixar Arquivo Original</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                    <!-- =============================================== -->
                                    <!--           FIM DA SEÇÃO CORRIGIDA                -->
                                    <!-- =============================================== -->
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <p>Nenhum dataset encontrado.</p>
                        <div class="mt-3">
                            <a href="{{ url_for('main.upload_data') }}" class="btn btn-success me-2">
                                <i class="fas fa-upload me-2"></i>
                                Fazer Primeiro Upload
                            </a>
                            <a href="{{ url_for('external.sources') }}" class="btn btn-primary">
                                <i class="fas fa-cloud-download-alt me-2"></i>
                                Importar Dados Externos
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Public Datasets -->
    {% if public_datasets %}
    <div class="row">
        <div class="col-12">
            <div class="card card-custom">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>
                        Datasets Públicos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome do Arquivo</th>
                                    <th>Upload por</th>
                                    <th>Linhas</th>
                                    <th>Colunas</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dataset in public_datasets %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-csv text-success me-2"></i>
                                        {{ dataset.original_filename }}
                                    </td>
                                    <td>{{ dataset.uploader.username }}</td>
                                    <td>{{ dataset.rows_count }}</td>
                                    <td>{{ dataset.columns_count }}</td>
                                    <td>{{ dataset.uploaded_at.strftime('%d/%m/%Y') if dataset.uploaded_at else 'N/A' }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="viewDataset({{ dataset.id }})" 
                                                    title="Visualizar Dataset">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="{{ url_for('main.download_dataset', dataset_id=dataset.id) }}" 
                                               class="btn btn-outline-success">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modais (permanecem os mesmos) -->
<!-- Dataset Info Modal -->
<div class="modal fade" id="datasetInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Informações do Dataset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="datasetInfoContent"></div>
        </div>
    </div>
</div>

<!-- Dataset Preview Modal -->
<div class="modal fade" id="datasetPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Visualização do Dataset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="datasetPreviewContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Seu JavaScript existente pode permanecer aqui, pois ele alimenta os modais -->
<script>
let currentDatasetId = null;

// Função para visualizar dataset com dados reais
async function viewDataset(datasetId) {
    currentDatasetId = datasetId;
    
    const modalContent = document.getElementById('datasetPreviewContent');
    modalContent.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">Carregando...</p></div>`;
    
    const modal = new bootstrap.Modal(document.getElementById('datasetPreviewModal'));
    modal.show();

    try {
        const response = await fetch(`/api/datasets/${datasetId}/preview`);
        const data = await response.json();
        
        if (data.success) {
            displayDatasetPreview(data);
        } else {
            modalContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    } catch (error) {
        modalContent.innerHTML = `<div class="alert alert-danger">Erro ao carregar dados.</div>`;
    }
}

function displayDatasetPreview(data) {
    const { dataset, preview } = data;
    let table = `<table class="table table-sm table-striped table-bordered"><thead><tr>`;
    preview.headers.forEach(h => table += `<th>${h}</th>`);
    table += `</tr></thead><tbody>`;
    preview.rows.forEach(row => {
        table += `<tr>`;
        row.forEach(cell => table += `<td>${cell !== null ? cell : ''}</td>`);
        table += `</tr>`;
    });
    table += `</tbody></table>`;

    document.getElementById('datasetPreviewContent').innerHTML = `
        <div class="alert alert-info">Mostrando as primeiras ${preview.rows.length} de ${preview.total_rows} linhas.</div>
        <div class="table-responsive" style="max-height: 400px;">${table}</div>
    `;
}

// Função para mostrar informações detalhadas do dataset
async function showDatasetInfo(datasetId) {
    const modalContent = document.getElementById('datasetInfoContent');
    modalContent.innerHTML = `<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Carregando...</p></div>`;
    
    const modal = new bootstrap.Modal(document.getElementById('datasetInfoModal'));
    modal.show();
    
    try {
        const response = await fetch(`/api/datasets/${datasetId}/info`);
        const data = await response.json();
        
        if (data.success) {
            const { dataset, analysis } = data;
            let html = `<h6>Informações Gerais</h6>
                        <p><strong>Arquivo:</strong> ${dataset.filename}<br>
                           <strong>Linhas:</strong> ${dataset.rows_count} | <strong>Colunas:</strong> ${dataset.columns_count}<br>
                           <strong>Qualidade:</strong> ${dataset.quality_score.toFixed(1)}%</p>
                        <h6>Colunas e Dados Faltantes</h6>`;
            Object.keys(analysis.missing_percentage).forEach(col => {
                const pct = analysis.missing_percentage[col];
                html += `<div class="mb-1">${col} <span class="badge bg-${pct > 10 ? 'warning' : 'light text-dark'}">${pct.toFixed(1)}% ausente</span></div>`;
            });
            modalContent.innerHTML = html;
        } else {
            modalContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    } catch (error) {
         modalContent.innerHTML = `<div class="alert alert-danger">Erro ao carregar informações.</div>`;
    }
}
</script>
{% endblock %}