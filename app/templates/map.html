{% extends "base.html" %}
{% block title %}Mapa Interativo - EcoPredict{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-map-marked-alt me-2"></i>
                Mapa Interativo da Qualidade do Ar
            </h1>
            <p class="text-muted">Visualize dados de qualidade do ar em tempo real</p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="refreshMapData()">
                    <i class="fas fa-sync-alt me-1"></i>Atualizar Dados
                </button>
                <button class="btn btn-outline-info" onclick="showMapLegend()">
                    <i class="fas fa-info-circle me-1"></i>Legenda
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Mapa -->
        <div class="col-12">
            <div class="card card-custom">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-globe-americas me-2"></i>
                        Mapa da Qualidade do Ar - Brasil
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2" id="liveIndicator">
                            <i class="fas fa-circle me-1"></i>Dados em Tempo Real
                        </span>
                        <span class="text-muted" id="lastUpdate">
                            Atualizado: {{ now.strftime('%H:%M') if now else '--:--' }}
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Legenda do Mapa -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card card-custom">
                <div class="card-body">
                    <h6 class="card-title">Legenda - √çndice de Qualidade do Ar (AQI)</h6>
                    <div class="row text-center">
                        <div class="col">
                            <div class="legend-item bg-success text-white p-2 rounded">
                                <small>0-50<br>Bom</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="legend-item bg-info text-white p-2 rounded">
                                <small>51-100<br>Moderado</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="legend-item bg-warning text-white p-2 rounded">
                                <small>101-150<br>Ruim</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="legend-item bg-orange text-white p-2 rounded">
                                <small>151-200<br>Muito Ruim</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="legend-item bg-danger text-white p-2 rounded">
                                <small>201-300<br>Perigoso</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="legend-item bg-dark text-white p-2 rounded">
                                <small>301+<br>Emerg√™ncia</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes da Cidade -->
<div class="modal fade" id="cityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cityModalTitle">
                    <i class="fas fa-city me-2"></i>
                    Detalhes da Qualidade do Ar
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="cityModalContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando dados da cidade...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="loadHistoricalData()">
                    <i class="fas fa-chart-line me-1"></i>Ver Hist√≥rico
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Legenda -->
<div class="modal fade" id="legendModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Legenda do Mapa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="legend-details">
                    <div class="legend-item mb-2 p-2 bg-success text-white rounded">
                        <strong>Bom (0-50):</strong> Qualidade do ar satisfat√≥ria, risco m√≠nimo
                    </div>
                    <div class="legend-item mb-2 p-2 bg-info text-white rounded">
                        <strong>Moderado (51-100):</strong> Qualidade aceit√°vel, risco moderado para grupos sens√≠veis
                    </div>
                    <div class="legend-item mb-2 p-2 bg-warning text-white rounded">
                        <strong>Ruim (101-150):</strong> Qualidade insalubre para grupos sens√≠veis
                    </div>
                    <div class="legend-item mb-2 p-2 bg-orange text-white rounded">
                        <strong>Muito Ruim (151-200):</strong> Qualidade insalubre para todos
                    </div>
                    <div class="legend-item mb-2 p-2 bg-danger text-white rounded">
                        <strong>Perigoso (201-300):</strong> Alerta de sa√∫de, efeitos graves
                    </div>
                    <div class="legend-item mb-2 p-2 bg-dark text-white rounded">
                        <strong>Emerg√™ncia (301+):</strong> Alertas de emerg√™ncia para toda popula√ß√£o
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.bg-orange {
    background-color: #fd7e14 !important;
}

.legend-item {
    transition: transform 0.2s;
}

.legend-item:hover {
    transform: scale(1.02);
}

#map {
    border-radius: 0 0 0.375rem 0.375rem;
}

.leaflet-popup-content {
    font-family: 'Inter', sans-serif;
}

.aqi-marker {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.marker-tooltip {
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-family: 'Inter', sans-serif;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Vari√°veis globais
let map;
let markers = [];
let currentCity = '';

// Dados das cidades do backend
const citiesData = {{ cities_data|tojson }};

// Fun√ß√£o para obter cor baseada no AQI
function getAqiColor(aqi) {
    if (aqi <= 50) return '#28a745';
    if (aqi <= 100) return '#17a2b8';
    if (aqi <= 150) return '#ffc107';
    if (aqi <= 200) return '#fd7e14';
    if (aqi <= 300) return '#dc3545';
    return '#6f42c1';
}

// Fun√ß√£o para obter classe de badge baseada no AQI
function getAqiBadgeClass(aqi) {
    if (aqi <= 50) return 'bg-success';
    if (aqi <= 100) return 'bg-info';
    if (aqi <= 150) return 'bg-warning';
    if (aqi <= 200) return 'bg-orange';
    if (aqi <= 300) return 'bg-danger';
    return 'bg-dark';
}

// Fun√ß√£o para obter descri√ß√£o do AQI
function getAqiDescription(aqi) {
    if (aqi <= 50) return 'Bom';
    if (aqi <= 100) return 'Moderado';
    if (aqi <= 150) return 'Ruim';
    if (aqi <= 200) return 'Muito Ruim';
    if (aqi <= 300) return 'Perigoso';
    return 'Emerg√™ncia';
}

// Inicializar mapa
function initMap() {
    // Centro do Brasil
    map = L.map('map').setView([-15.7801, -47.9292], 4);

    // Adicionar tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);

    // Adicionar marcadores para cada cidade
    Object.entries(citiesData).forEach(([city, data]) => {
        const aqi = data.aqi || 50;
        const color = getAqiColor(aqi);
        
        // Criar √≠cone personalizado
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `
                <div class="aqi-marker" style="background-color: ${color};">
                    ${Math.round(aqi)}
                </div>
            `,
            iconSize: [35, 35],
            iconAnchor: [17, 17]
        });

        // Criar marcador
        const marker = L.marker([data.lat, data.lon], { icon: customIcon })
            .addTo(map)
            .bindTooltip(`
                <div class="marker-tooltip">
                    <strong>${city}</strong><br>
                    AQI: ${Math.round(aqi)} (${getAqiDescription(aqi)})<br>
                    PM2.5: ${data.pm25 ? data.pm25.toFixed(1) : 'N/A'} ¬µg/m¬≥<br>
                    Temp: ${data.temp ? data.temp.toFixed(1) + '¬∞C' : 'N/A'}
                </div>
            `, {
                permanent: false,
                direction: 'top',
                offset: [0, -10]
            })
            .on('click', function() {
                showCityDetails(city, data);
            });

        markers.push(marker);
    });

    // Atualizar indicador de √∫ltima atualiza√ß√£o
    updateLastUpdateTime();
}

// Mostrar detalhes da cidade
function showCityDetails(city, data) {
    currentCity = city;
    
    const modalTitle = document.getElementById('cityModalTitle');
    const modalContent = document.getElementById('cityModalContent');
    
    modalTitle.innerHTML = `<i class="fas fa-city me-2"></i>${city} - Qualidade do Ar`;
    
    const aqi = data.aqi || 50;
    const badgeClass = getAqiBadgeClass(aqi);
    const description = getAqiDescription(aqi);
    
    modalContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card ${badgeClass.replace('bg-', 'border-')} text-${badgeClass.replace('bg-', '')} mb-3">
                    <div class="card-body text-center">
                        <h3 class="card-title">${Math.round(aqi)}</h3>
                        <p class="card-text">√çndice AQI</p>
                        <span class="badge ${badgeClass}">${description}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-secondary mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Poluentes Principais</h6>
                        <div class="pollutant-list">
                            <div class="d-flex justify-content-between mb-2">
                                <span>PM2.5:</span>
                                <strong>${data.pm25 ? data.pm25.toFixed(1) + ' ¬µg/m¬≥' : 'N/A'}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>PM10:</span>
                                <strong>${data.pm10 ? data.pm10.toFixed(1) + ' ¬µg/m¬≥' : 'N/A'}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>O‚ÇÉ:</span>
                                <strong>${data.o3 ? data.o3.toFixed(1) + ' ppb' : 'N/A'}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-body">
                        <h6 class="card-title">Condi√ß√µes Meteorol√≥gicas</h6>
                        <div class="weather-info">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Temperatura:</span>
                                <strong>${data.temp ? data.temp.toFixed(1) + '¬∞C' : 'N/A'}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Umidade:</span>
                                <strong>${data.humidity ? data.humidity + '%' : 'N/A'}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Press√£o:</span>
                                <strong>${data.pressure ? data.pressure + ' hPa' : 'N/A'}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-body">
                        <h6 class="card-title">Recomenda√ß√µes</h6>
                        <div class="recommendations">
                            ${getHealthRecommendations(aqi)}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Fonte dos dados:</strong> ${getDataSourceInfo(city)}
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('cityModal'));
    modal.show();
}

// Obter recomenda√ß√µes de sa√∫de
function getHealthRecommendations(aqi) {
    if (aqi <= 50) {
        return `
            <p class="mb-1">‚úÖ Condi√ß√µes ideais para atividades ao ar livre</p>
            <p class="mb-0">‚úÖ Qualidade do ar satisfat√≥ria</p>
        `;
    } else if (aqi <= 100) {
        return `
            <p class="mb-1">‚ö†Ô∏è Grupos sens√≠veis devem reduzir atividades intensas</p>
            <p class="mb-0">‚úÖ Condi√ß√µes aceit√°veis para a maioria</p>
        `;
    } else if (aqi <= 150) {
        return `
            <p class="mb-1">‚ö†Ô∏è Grupos sens√≠veis devem evitar atividades ao ar livre</p>
            <p class="mb-0">‚ö†Ô∏è Todos devem reduzir atividades prolongadas</p>
        `;
    } else if (aqi <= 200) {
        return `
            <p class="mb-1">üö´ Grupos sens√≠veis devem permanecer em ambientes fechados</p>
            <p class="mb-0">‚ö†Ô∏è Todos devem evitar atividades ao ar livre</p>
        `;
    } else {
        return `
            <p class="mb-1">üö´ Evitar qualquer atividade ao ar livre</p>
            <p class="mb-0">üö´ Usar m√°scara de prote√ß√£o se necess√°rio sair</p>
        `;
    }
}

// Obter informa√ß√µes da fonte de dados
function getDataSourceInfo(city) {
    return `Sistema EcoPredict - Dados combinados de fontes oficiais e esta√ß√µes de monitoramento em ${city}.`;
}

// Atualizar dados do mapa
// Atualizar dados do mapa com API
async function refreshMapData() {
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Atualizando...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/map/data');
        const result = await response.json();
        
        if (result.success) {
            // Atualizar dados das cidades
            Object.entries(result.data).forEach(([city, data]) => {
                if (citiesData[city]) {
                    citiesData[city].aqi = data.aqi;
                    citiesData[city].pm25 = data.pm25;
                    citiesData[city].pm10 = data.pm10;
                    citiesData[city].o3 = data.o3;
                    citiesData[city].temp = data.temp;
                    citiesData[city].humidity = data.humidity;
                    citiesData[city].pressure = data.pressure;
                }
            });
            
            // Atualizar marcadores no mapa
            updateMapMarkers();
            
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            updateLastUpdateTime();
            showToast('Dados do mapa atualizados com sucesso!', 'success');
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Erro ao atualizar dados:', error);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        showToast('Erro ao atualizar dados do mapa', 'danger');
    }
}

// Atualizar marcadores do mapa
function updateMapMarkers() {
    // Remover marcadores antigos
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    
    // Adicionar novos marcadores com dados atualizados
    Object.entries(citiesData).forEach(([city, data]) => {
        const aqi = data.aqi || 50;
        const color = getAqiColor(aqi);
        
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `
                <div class="aqi-marker" style="background-color: ${color};">
                    ${Math.round(aqi)}
                </div>
            `,
            iconSize: [35, 35],
            iconAnchor: [17, 17]
        });

        const marker = L.marker([data.lat, data.lon], { icon: customIcon })
            .addTo(map)
            .bindTooltip(`
                <div class="marker-tooltip">
                    <strong>${city}</strong><br>
                    AQI: ${Math.round(aqi)} (${getAqiDescription(aqi)})<br>
                    PM2.5: ${data.pm25 ? data.pm25.toFixed(1) : 'N/A'} ¬µg/m¬≥<br>
                    Temp: ${data.temp ? data.temp.toFixed(1) + '¬∞C' : 'N/A'}
                </div>
            `)
            .on('click', function() {
                showCityDetails(city, data);
            });

        markers.push(marker);
    });
}

// Atualizar hor√°rio da √∫ltima atualiza√ß√£o
function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('lastUpdate').textContent = `Atualizado: ${timeString}`;
}

// Mostrar legenda
function showMapLegend() {
    const modal = new bootstrap.Modal(document.getElementById('legendModal'));
    modal.show();
}

// Carregar dados hist√≥ricos
function loadHistoricalData() {
    if (!currentCity) return;
    
    showToast(`Carregando dados hist√≥ricos para ${currentCity}...`, 'info');
    
    // Aqui voc√™ implementaria a busca de dados hist√≥ricos
    setTimeout(() => {
        showToast(`Dados hist√≥ricos de ${currentCity} carregados`, 'success');
    }, 1500);
}

// Fun√ß√£o de toast
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${getToastIcon(type)} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function getToastIcon(type) {
    const icons = {
        'success': 'check-circle',
        'danger': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Inicializar mapa quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    // Atualizar dados automaticamente a cada 5 minutos
    setInterval(() => {
        refreshMapData();
    }, 300000);
});
</script>
{% endblock %}